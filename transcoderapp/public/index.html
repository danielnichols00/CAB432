<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Transcoder • Express + FFmpeg</title>
  <link rel="stylesheet" href="/styles.css" />
</head>
<body>
  <header class="site-header">
    <div class="container header-inner">
      <div class="brand">
        <div class="logo">🎬</div>
        <div class="brand-text">
          <h1>Transcoder</h1>
          <p>Fast, reliable video conversion</p>
        </div>
      </div>
      <nav class="nav">
        <a href="/" class="nav-link" id="navHome">Home</a>
        <a href="#" class="nav-link" id="navLoginBtn">Login</a>
        <a href="#" class="nav-link" id="navRegisterBtn">Register</a>
        <a href="#" class="nav-link hidden" id="navLogoutBtn">Logout</a>
        <span id="roleBadge" class="badge hidden">Admin</span>
      </nav>
    </div>
  </header>

  <!-- Backdrop + Slide-over Register -->
  <div id="backdrop" class="backdrop hidden" aria-hidden="true"></div>
  <aside id="registerDrawer" class="drawer" aria-hidden="true" aria-labelledby="drawerTitle" role="dialog">
    <div class="drawer-header">
      <h3 id="drawerTitle">Create account</h3>
      <button class="drawer-close" id="closeDrawer" aria-label="Close">✕</button>
    </div>
    <div class="drawer-body">
      <p class="muted tiny">Register with username, email, and password. Then confirm using the code emailed to you.</p>

      <form id="signUpForm" class="stack">
        <div class="field">
          <label for="su_username">Username</label>
          <input id="su_username" name="username" placeholder="yourname" required />
        </div>
        <div class="field">
          <label for="su_email">Email</label>
          <input id="su_email" name="email" type="email" placeholder="you@example.com" required />
        </div>
        <div class="field">
          <label for="su_password">Password</label>
          <input id="su_password" name="password" type="password" placeholder="P@ssw0rd!" required />
        </div>
        <div class="actions">
          <button class="btn primary" type="submit">Create account</button>
        </div>
        <div id="signUpState" class="muted"></div>
      </form>

      <hr class="sep" />

      <h4>Confirm account</h4>
      <p class="muted tiny">Enter the 6-digit code sent to your email.</p>

      <form id="confirmForm" class="stack">
        <div class="field">
          <label for="cf_username">Username</label>
          <input id="cf_username" name="username" placeholder="yourname" required />
        </div>
        <div class="field">
          <label for="cf_code">Confirmation code</label>
          <input id="cf_code" name="code" placeholder="123456" required />
        </div>
        <div class="actions">
          <button class="btn primary" type="submit">Confirm</button>
        </div>
        <div id="confirmState" class="muted"></div>
      </form>
    </div>
  </aside>

  <main class="container main">
    <section class="grid">
      <!-- Login -->
      <div class="card" id="loginCard">
        <h2>Sign in</h2>
        <form id="loginForm" class="stack">
          <div class="field two-col">
            <div>
              <label for="username">Username</label>
              <input id="username" name="username" placeholder="yourname" required />
            </div>
            <div>
              <label for="password">Password</label>
              <input id="password" name="password" type="password" placeholder="••••••••" required />
            </div>
          </div>
          <div class="actions">
            <button class="btn primary" type="submit">Sign in</button>
          </div>
          <div id="authState" class="muted"></div>
        </form>
      </div>

      <!-- Upload -->
      <div class="card">
        <h2>Upload</h2>
        <p class="muted">Upload a video. Then transcode it below.</p>
        <form id="uploadForm" class="stack" enctype="multipart/form-data">
          <div class="field">
            <label for="video">Video file</label>
            <input id="video" name="video" type="file" accept="video/*" required />
          </div>
          <div class="actions">
            <button class="btn primary" type="submit" disabled id="uploadBtn">Upload</button>
            <button class="btn" type="reset" id="resetUpload">Reset</button>
          </div>
          <div id="uploadProgress" class="progress-wrap hidden">
            <div class="progress"><div class="progress-bar" id="uploadBar"></div></div>
            <div id="uploadText" class="progress-text">Preparing…</div>
          </div>
          <div id="uploadResult" class="result hidden"></div>
        </form>
      </div>

      <!-- Library -->
      <div class="card">
        <h2>Library</h2>
        <p class="muted tiny">Switch between uploads and processed outputs.</p>

        <!-- Tabs -->
        <div class="tabs">
          <button class="tab active" id="tabUploads" type="button">Uploads</button>
          <button class="tab" id="tabProcessed" type="button">Processed</button>
        </div>

        <!-- Transcode controls (hide when viewing Processed) -->
        <div id="transcodeControls">
          <div class="field two-col">
            <div>
              <label for="format">Output format</label>
              <select id="format">
                <option value="mp4">MP4 (H.264/AAC)</option>
                <option value="webm">WebM (VP9/Opus)</option>
                <option value="avi">AVI</option>
              </select>
            </div>
            <div>
              <label for="preset">Quality / Speed</label>
              <select id="preset">
                <option value="fast">fast (bigger file)</option>
                <option value="medium" selected>medium</option>
                <option value="slow">slow (smaller file)</option>
              </select>
            </div>
          </div>

          <div class="field two-col">
            <div>
              <label for="scale">Scale</label>
              <select id="scale">
                <option value="source" selected>Keep source</option>
                <option value="1080p">1080p</option>
                <option value="720p">720p</option>
              </select>
            </div>
            <div>
              <label for="fps">Frame rate</label>
              <select id="fps">
                <option value="source" selected>Keep source</option>
                <option value="30">30 fps</option>
                <option value="60">60 fps</option>
              </select>
            </div>
          </div>

          <div class="field">
            <label><input type="checkbox" id="enhance" /> Enhance (mild brightness/contrast)</label>
          </div>

          <div class="actions">
            <button class="btn" id="refreshBtn" disabled>Refresh</button>
          </div>
        </div>

        <ul id="videoList" class="list"></ul>
        <div id="listError" class="error"></div>
      </div>

      <!-- API cheat sheet -->
      <div class="card">
        <h2>API</h2>
        <ul class="api-list">
          <li><code>POST /auth/sign-up</code> → <code>{ ok }</code></li>
          <li><code>POST /auth/confirm</code> → <code>{ ok }</code></li>
          <li><code>POST /auth/login</code> → <code>{ authToken, idToken, accessToken }</code></li>
          <li><code>GET /auth/me</code> → <code>{ sub, email, groups }</code></li>
          <li><code>GET /videos</code> → <code>{ files: [...] }</code></li>
          <li><code>POST /videos/upload</code> (multipart <code>video</code>)</li>
          <li><code>POST /videos/transcode</code> (<code>{ filename, format, preset, scale, fps, enhance }</code>)</li>
          <li><code>GET /videos/download/:type/:name</code> → <code>{ url }</code></li>
        </ul>
      </div>
    </section>
  </main>

  <footer class="site-footer">
    <div class="container">
      <span>© Transcoder • Express + FFmpeg</span>
    </div>
  </footer>

  <script>
    // --- State ---
    let token = null;
    let currentTab = 'uploads'; // 'uploads' | 'processed'

    // --- Elements (nav/drawer) ---
    const navLoginBtn    = document.getElementById('navLoginBtn');
    const navRegisterBtn = document.getElementById('navRegisterBtn');
    const navLogoutBtn   = document.getElementById('navLogoutBtn');
    const loginCard      = document.getElementById('loginCard');

    const backdrop       = document.getElementById('backdrop');
    const drawer         = document.getElementById('registerDrawer');
    const closeDrawerBtn = document.getElementById('closeDrawer');
    const roleBadge      = document.getElementById('roleBadge');

    // Forms
    const signUpForm   = document.getElementById('signUpForm');
    const signUpState  = document.getElementById('signUpState');
    const confirmForm  = document.getElementById('confirmForm');
    const confirmState = document.getElementById('confirmState');

    const loginForm    = document.getElementById('loginForm');
    const authState    = document.getElementById('authState');

    const uploadForm   = document.getElementById('uploadForm');
    const uploadBtn    = document.getElementById('uploadBtn');
    const refreshBtn   = document.getElementById('refreshBtn');
    const uploadProgress = document.getElementById('uploadProgress');
    const uploadBar    = document.getElementById('uploadBar');
    const uploadText   = document.getElementById('uploadText');
    const uploadResult = document.getElementById('uploadResult');
    const resetUpload  = document.getElementById('resetUpload');
    const videoList    = document.getElementById('videoList');
    const listError    = document.getElementById('listError');

    // Transcode controls
    const transcodeControls = document.getElementById('transcodeControls');
    const formatSel  = document.getElementById('format');
    const presetSel  = document.getElementById('preset');
    const scaleSel   = document.getElementById('scale');
    const fpsSel     = document.getElementById('fps');
    const enhanceChk = document.getElementById('enhance');

    // Tabs
    const tabUploads   = document.getElementById('tabUploads');
    const tabProcessed = document.getElementById('tabProcessed');

    // UI helpers
    function show(el){ el.classList.remove('hidden'); }
    function hide(el){ el.classList.add('hidden'); }
    function openDrawer(){ drawer.classList.add('open'); backdrop.classList.remove('hidden'); drawer.setAttribute('aria-hidden','false'); }
    function closeDrawer(){ drawer.classList.remove('open'); backdrop.classList.add('hidden'); drawer.setAttribute('aria-hidden','true'); }

    function enableAuthedUI(enabled){
      uploadBtn.disabled = !enabled;
      refreshBtn.disabled = !enabled;
    }

    async function loadIdentity(){
      try {
        const res = await fetch('/auth/me', { headers: { Authorization: 'Bearer ' + token } });
        if (!res.ok) throw new Error('auth/me failed');
        const me = await res.json();
        const groups = Array.isArray(me.groups) ? me.groups : [];
        const isAdmin = groups.map(g => String(g).toLowerCase()).includes('admin');
        sessionStorage.setItem('isAdmin', isAdmin ? '1' : '0');
        sessionStorage.setItem('groups', JSON.stringify(groups));
        roleBadge.classList.toggle('hidden', !isAdmin);
      } catch {
        roleBadge.classList.add('hidden');
      }
    }

    function updateNav(){
      const loggedIn = !!sessionStorage.getItem('authToken');
      if (loggedIn){
        hide(navLoginBtn); hide(navRegisterBtn); show(navLogoutBtn);
      } else {
        show(navLoginBtn); show(navRegisterBtn); hide(navLogoutBtn);
      }
    }

    function setToken(t, username){
      token = t;
      if (t) {
        sessionStorage.setItem('authToken', t);
        if (username) sessionStorage.setItem('username', username);
        authState.textContent = `Signed in as ${username || sessionStorage.getItem('username') || ''}`;
        enableAuthedUI(true);
        updateNav();
        loadIdentity();
        loadList();
      } else {
        sessionStorage.removeItem('authToken');
        sessionStorage.removeItem('username');
        sessionStorage.removeItem('isAdmin');
        sessionStorage.removeItem('groups');
        roleBadge.classList.add('hidden');
        authState.textContent = 'Signed out';
        enableAuthedUI(false);
        updateNav();
        videoList.innerHTML = '';
      }
    }

    function setTab(tab){
      currentTab = tab;
      if (tab === 'uploads'){
        tabUploads.classList.add('active');
        tabProcessed.classList.remove('active');
        transcodeControls.classList.remove('hidden');
      } else {
        tabProcessed.classList.add('active');
        tabUploads.classList.remove('active');
        transcodeControls.classList.add('hidden');
      }
      loadList();
    }

    // Restore on refresh
    (function restore(){
      const t = sessionStorage.getItem('authToken');
      const u = sessionStorage.getItem('username');
      if (t) setToken(t, u); else updateNav();
    })();

    // --- Nav actions ---
    navLoginBtn.addEventListener('click', (e) => {
      e.preventDefault();
      loginCard.scrollIntoView({ behavior: 'smooth', block: 'start' });
    });
    navRegisterBtn.addEventListener('click', (e) => {
      e.preventDefault();
      openDrawer();
      document.getElementById('su_username').focus();
    });
    navLogoutBtn.addEventListener('click', (e) => {
      e.preventDefault();
      setToken(null);
    });
    backdrop.addEventListener('click', closeDrawer);
    closeDrawerBtn.addEventListener('click', closeDrawer);
    document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeDrawer(); });

    // --- Register ---
    signUpForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const fd = new FormData(signUpForm);
      const body = Object.fromEntries(fd.entries());
      signUpState.textContent = 'Creating account…';
      try {
        const res = await fetch('/auth/sign-up', {
          method: 'POST',
          headers: { 'Content-Type':'application/json' },
          body: JSON.stringify(body)
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'Sign-up failed');
        signUpState.textContent = '✅ Account created. Check your email for the confirmation code.';
        document.getElementById('cf_username').value = body.username;
        document.getElementById('cf_code').focus();
      } catch (err) {
        signUpState.textContent = '❌ ' + err.message;
      }
    });

    // --- Confirm ---
    confirmForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const fd = new FormData(confirmForm);
      const body = Object.fromEntries(fd.entries());
      confirmState.textContent = 'Confirming…';
      try {
        const res = await fetch('/auth/confirm', {
          method: 'POST',
          headers: { 'Content-Type':'application/json' },
          body: JSON.stringify(body)
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'Confirmation failed');
        confirmState.textContent = '✅ Account confirmed. You can now sign in.';
        document.getElementById('username').value = body.username;
        setTimeout(closeDrawer, 600);
      } catch (err) {
        confirmState.textContent = '❌ ' + err.message;
      }
    });

    // --- Login ---
    const loginFormEl = document.getElementById('loginForm');
    loginFormEl.addEventListener('submit', async (e) => {
      e.preventDefault();
      const fd = new FormData(loginFormEl);
      const body = Object.fromEntries(fd.entries());
      try {
        const res = await fetch('/auth/login', {
          method: 'POST',
          headers: { 'Content-Type':'application/json' },
          body: JSON.stringify(body)
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'Invalid credentials');
        setToken(data.authToken, data.username);
      } catch (err) {
        authState.textContent = 'Login failed: ' + err.message;
        enableAuthedUI(false);
      }
    });

    // --- Upload with progress ---
    uploadForm.addEventListener('submit', (e) => {
      e.preventDefault();
      if (!token) { alert('Sign in first.'); return; }
      const fd = new FormData(uploadForm);
      const xhr = new XMLHttpRequest();
      xhr.open('POST', '/videos/upload', true);
      xhr.setRequestHeader('Authorization', 'Bearer ' + token);

      show(uploadProgress); hide(uploadResult);
      uploadBar.style.width = '0%'; uploadText.textContent = 'Starting…';

      xhr.upload.onprogress = (evt) => {
        if (evt.lengthComputable) {
          const pct = (evt.loaded / evt.total) * 100;
          uploadBar.style.width = pct.toFixed(0) + '%';
          uploadText.textContent = `Uploading… ${pct.toFixed(0)}%`;
        }
      };

      xhr.onreadystatechange = () => {
        if (xhr.readyState === 4) {
          if (xhr.status >= 200 && xhr.status < 300) {
            const resp = JSON.parse(xhr.responseText);
            uploadResult.innerHTML = `<div class="success">✅ Uploaded <code>${resp.filename}</code></div>`;
            loadList();
          } else {
            uploadResult.innerHTML = `<div class="error">❌ Upload failed: ${xhr.responseText || xhr.statusText}</div>`;
          }
          show(uploadResult); hide(uploadProgress);
          uploadForm.reset();
        }
      };

      xhr.send(fd);
    });
    resetUpload.addEventListener('click', () => { hide(uploadProgress); hide(uploadResult); });

    // --- Helpers ---
    function extractVariant(name){
      // strip extension first, then match our variant suffix
      const noExt = name.replace(/\.[^.]+$/, '');
      const m = noExt.match(/_(fast|medium|slow)_(src|1080p|720p)_(src|\d+fps)(?:_enh)?$/);
      return m ? m[0].slice(1) : '';
    }

    async function presignedDownload(type, name){
      const res = await fetch(`/videos/download/${encodeURIComponent(type)}/${encodeURIComponent(name)}`, {
        headers: { Authorization: 'Bearer ' + token }
      });
      if (!res.ok) throw new Error('Failed to get download URL');
      const { url } = await res.json();
      if (!url) throw new Error('No URL returned');
      window.open(url, '_blank');
    }

    // --- List renderers ---
    function renderUploads(items){
      if (!items || !items.length) {
        videoList.innerHTML = '<li class="muted">No videos yet.</li>';
        return;
      }
      videoList.innerHTML = items.map(it => {
        const uploaded = it.lastModified ? new Date(it.lastModified).toLocaleString() : '';
        return `
          <li class="list-item">
            <div class="file-col">
              <div>
                <strong>${it.name}</strong>
                <div class="muted tiny">Owner: ${it.owner}${uploaded ? ' • Uploaded: ' + uploaded : ''}</div>
              </div>
            </div>
            <div class="actions">
              <button class="btn" data-action="transcode" data-filename="${it.name}">
                Transcode → ${formatSel.value}/${presetSel.value}
              </button>
              <button class="btn link" data-action="download" data-type="uploads" data-name="${it.name}">
                Download original
              </button>
            </div>
          </li>`;
      }).join('');
    }

function renderProcessed(items){
    if (!items || !items.length) {
      videoList.innerHTML = '<li class="muted">No processed outputs yet.</li>';
      return;
    }
    items.sort((a,b) => a.name.localeCompare(b.name));
    videoList.innerHTML = items.map(it => {
      const variant = it.variant || '';
      return `
        <li class="list-item">
          <div class="file-col">
            <div>
              <strong>${it.name}</strong>
              <div class="muted tiny">
                From: ${it.original} • Owner: ${it.owner}${variant ? ' • Variant: ' + variant : ''}
              </div>
            </div>
          </div>
          <div class="actions">
            <button class="btn link" data-action="download" data-type="processed" data-name="${it.name}">Download</button>
            <button class="btn link" data-action="download" data-type="uploads" data-name="${it.original}">Original</button>
          </div>
        </li>`;
    }).join('');
  }



      // --- List loader (switch by tab) ---
  async function loadList(){
    listError.textContent = '';
    videoList.innerHTML = '';
    if (!token) { listError.textContent = 'Not signed in.'; return; }

    const endpoint = currentTab === 'uploads' ? '/videos/uploads' : '/videos/processed';
    try {
      const res = await fetch(endpoint, {
        headers: { Authorization: 'Bearer ' + token }
      });

      // Better diagnostics
      if (!res.ok) {
        const text = await res.text().catch(() => '');
        console.debug('[loadList] endpoint:', endpoint, 'status:', res.status, 'body:', text);
        if (res.status === 401) {
          listError.textContent = 'Session expired or not authorized. Please sign in again.';
          // optional: auto sign-out UI
          setToken(null);
          return;
        }
        throw new Error(`HTTP ${res.status}${text ? `: ${text}` : ''}`);
      }

      const data = await res.json();
      const items = Array.isArray(data.items) ? data.items : [];
      if (currentTab === 'uploads') renderUploads(items);
      else renderProcessed(items);
    } catch (e) {
      listError.textContent = 'Could not load list: ' + (e.message || e);
    }
  }

    // Tab clicks
    tabUploads.addEventListener('click', () => setTab('uploads'));
    tabProcessed.addEventListener('click', () => setTab('processed'));

    // Click delegation (transcode + download)
    videoList.addEventListener('click', async (e) => {
      const actionBtn = e.target.closest('button[data-action]');
      if (!actionBtn) return;
      const action = actionBtn.getAttribute('data-action');

      if (action === 'transcode') {
        if (!token) { alert('Sign in first.'); return; }
        const filename = actionBtn.getAttribute('data-filename');
        const format   = formatSel.value;
        const preset   = presetSel.value;
        const scale    = scaleSel.value;
        const fps      = fpsSel.value;
        const enhance  = enhanceChk.checked;

        actionBtn.disabled = true; actionBtn.textContent = 'Transcoding…';
        try {
          const res = await fetch('/videos/transcode', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', Authorization: 'Bearer ' + token },
            body: JSON.stringify({ filename, format, preset, scale, fps, enhance })
          });
          if (!res.ok) throw new Error(await res.text());
          await loadList();
        } catch (err) {
          alert('Transcode failed: ' + err.message);
        } finally {
          actionBtn.disabled = false; actionBtn.textContent = `Transcode → ${format}/${preset}`;
        }
      }

      if (action === 'download') {
        const type = actionBtn.getAttribute('data-type');      // uploads | processed
        const name = actionBtn.getAttribute('data-name');      // filename or processed name
        try {
          await presignedDownload(type, name);
        } catch (err) {
          alert('Download failed: ' + err.message);
        }
      }
    });

    document.getElementById('refreshBtn').addEventListener('click', loadList);
  </script>
</body>
</html>
